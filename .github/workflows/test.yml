name: Run Tests

on:
  pull_request:
    branches: [ develop, main ]

jobs:
  test:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python environment
        run: |
          # Use persistent venv in runner's home directory
          VENV_PATH="$HOME/.venvs/personal-finances"
          mkdir -p "$HOME/.venvs"

          REQUIREMENTS_HASH=$(cat requirements.txt requirements-dev.txt | md5sum | cut -d' ' -f1)
          HASH_FILE="$VENV_PATH/.requirements_hash"

          # Recreate venv if requirements changed or venv doesn't exist
          if [ ! -d "$VENV_PATH" ] || [ ! -f "$HASH_FILE" ] || [ "$(cat $HASH_FILE)" != "$REQUIREMENTS_HASH" ]; then
            echo "Creating/updating virtual environment..."
            rm -rf "$VENV_PATH"
            python3 -m venv "$VENV_PATH"
            source "$VENV_PATH/bin/activate"
            pip install --upgrade pip
            pip install -r requirements.txt -r requirements-dev.txt
            echo "$REQUIREMENTS_HASH" > "$HASH_FILE"
          else
            echo "Using existing virtual environment (requirements unchanged)"
          fi

      - name: Run tests and checks
        run: |
          source "$HOME/.venvs/personal-finances/bin/activate"
          pytest -v --tb=short
          flake8 .
          black --check --diff .
