<!DOCTYPE html>
<html lang="en" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Recurring Expenses - Personal Finances</title>

    <!-- Icons -->
    <link rel="icon" href="/static/pficon.png">
    <link rel="apple-touch-icon" href="/static/pficon.png">
    <link rel="manifest" href="/static/site.webmanifest">

    <!-- Mobile Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Recurring">
    <meta name="application-name" content="Recurring">
    <meta name="theme-color" content="#007AFF">
    <meta name="msapplication-TileColor" content="#007AFF">
    <meta name="msapplication-TileImage" content="/static/pficon.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom Styles -->
    <link rel="stylesheet" href="/static/styles/theme.css">
</head>

<body>
    <nav-bar></nav-bar>
    <toast-container></toast-container>

    <div class="container py-2">
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="mb-0">Recurring Expenses</h2>
                    <button class="btn btn-primary" id="add-recurring-btn">
                        <i class="bi bi-plus-lg"></i> Add
                    </button>
                </div>

                <recurring-list></recurring-list>
            </div>
        </div>
    </div>

    <!-- Modal for adding/editing recurring expenses -->
    <div class="modal fade" id="recurring-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recurring-modal-title">Add Recurring Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="recurring-form">
                        <div class="mb-3">
                            <label for="recurring-amount" class="form-label">Amount</label>
                            <input type="number" class="form-control" id="recurring-amount" step="0.01" required>
                        </div>
                        <div class="mb-3">
                            <label for="recurring-category" class="form-label">Category</label>
                            <select class="form-select" id="recurring-category" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="recurring-description" class="form-label">Description</label>
                            <input type="text" class="form-control" id="recurring-description" maxlength="50" required>
                        </div>
                        <div class="mb-3">
                            <label for="recurring-frequency" class="form-label">Frequency</label>
                            <select class="form-select" id="recurring-frequency" required>
                                <option value="monthly">Monthly</option>
                                <option value="weekly">Weekly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="recurring-day" class="form-label">Day of Month (1-31)</label>
                            <input type="number" class="form-control" id="recurring-day" min="1" max="31" placeholder="e.g., 1 for 1st of month">
                        </div>
                        <div class="mb-3">
                            <label for="recurring-start-date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="recurring-start-date" required>
                        </div>
                        <div class="mb-3">
                            <label for="recurring-end-date" class="form-label">End Date (Optional)</label>
                            <input type="date" class="form-control" id="recurring-end-date">
                            <div class="form-text">Leave empty for no end date</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="recurring-submit-btn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Core Modules -->
    <script type="module" src="/static/components/config.js"></script>
    <script type="module" src="/static/components/api-service.js"></script>
    <script type="module" src="/static/components/event-manager.js"></script>

    <!-- Custom Components -->
    <script src="/static/components/navbar.js"></script>
    <script src="/static/components/toast.js"></script>
    <script type="module" src="/static/components/recurring-list.js"></script>

    <script>
        // Dark mode initialization - run immediately
        (function () {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');

            document.documentElement.setAttribute('data-bs-theme', theme);
            localStorage.setItem('theme', theme);
        })();

        // Dark mode toggle functionality
        function initDarkMode() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', theme);
        }

        // Initialize dark mode on page load
        document.addEventListener('DOMContentLoaded', initDarkMode);

        // Modal and form handling
        let recurringModal;
        let currentMode = 'create';
        let currentRecurringId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            recurringModal = new bootstrap.Modal(document.getElementById('recurring-modal'));

            // Populate categories
            const { CategoryHelper } = await import('/static/components/config.js');
            const categorySelect = document.getElementById('recurring-category');
            CategoryHelper.getAllCategories().forEach(key => {
                const cat = CategoryHelper.getCategoryData(key);
                const option = document.createElement('option');
                option.value = key;
                option.textContent = cat.label;
                categorySelect.appendChild(option);
            });

            // Handle add button
            document.getElementById('add-recurring-btn').addEventListener('click', () => {
                currentMode = 'create';
                currentRecurringId = null;
                document.getElementById('recurring-modal-title').textContent = 'Add Recurring Expense';
                document.getElementById('recurring-form').reset();
                document.getElementById('recurring-start-date').value = new Date().toISOString().split('T')[0];
                recurringModal.show();
            });

            // Handle form submission
            document.getElementById('recurring-submit-btn').addEventListener('click', async (e) => {
                e.preventDefault();

                const frequency = document.getElementById('recurring-frequency').value;
                const dayValue = parseInt(document.getElementById('recurring-day').value) || null;

                // Validate day based on frequency
                if (dayValue !== null) {
                    if (frequency === 'weekly' && (dayValue < 1 || dayValue > 7)) {
                        window.showToast('Day of week must be between 1 (Monday) and 7 (Sunday)', 'error');
                        return;
                    }
                    if ((frequency === 'monthly' || frequency === 'yearly') && (dayValue < 1 || dayValue > 31)) {
                        window.showToast('Day of month must be between 1 and 31', 'error');
                        return;
                    }
                }

                const formData = {
                    amount: parseFloat(document.getElementById('recurring-amount').value),
                    category: document.getElementById('recurring-category').value,
                    description: document.getElementById('recurring-description').value,
                    frequency: frequency,
                    day_of_month: dayValue,
                    start_date: document.getElementById('recurring-start-date').value,
                    end_date: document.getElementById('recurring-end-date').value || null
                };

                try {
                    const url = currentMode === 'create'
                        ? '/api/recurring'
                        : `/api/recurring/${currentRecurringId}`;
                    const method = currentMode === 'create' ? 'POST' : 'PUT';

                    const response = await fetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) throw new Error('Failed to save');

                    window.showToast(currentMode === 'create' ? 'Recurring expense added!' : 'Recurring expense updated!', 'success');
                    recurringModal.hide();

                    // Refresh the list
                    const event = new CustomEvent(currentMode === 'create' ? 'recurringadded' : 'recurringupdated');
                    document.dispatchEvent(event);
                } catch (error) {
                    window.showToast('Error saving recurring expense', 'error');
                }
            });

            // Update day field label and max based on frequency
            document.getElementById('recurring-frequency').addEventListener('change', (e) => {
                const dayField = document.getElementById('recurring-day');
                const dayLabel = document.querySelector('label[for="recurring-day"]');
                if (e.target.value === 'weekly') {
                    dayLabel.textContent = 'Day of Week (1=Mon, 7=Sun)';
                    dayField.max = '7';
                    dayField.placeholder = 'e.g., 1 for Monday';
                } else {
                    dayLabel.textContent = 'Day of Month (1-31)';
                    dayField.max = '31';
                    dayField.placeholder = 'e.g., 1 for 1st of month';
                }
            });

            // Listen for edit events from the list
            document.addEventListener('show-recurring-form', (e) => {
                if (e.detail.mode === 'edit' && e.detail.recurring) {
                    currentMode = 'edit';
                    const data = e.detail.recurring;
                    currentRecurringId = data.id;

                    document.getElementById('recurring-modal-title').textContent = 'Edit Recurring Expense';
                    document.getElementById('recurring-amount').value = data.amount;
                    document.getElementById('recurring-category').value = data.category;
                    document.getElementById('recurring-description').value = data.description;
                    document.getElementById('recurring-frequency').value = data.frequency;
                    document.getElementById('recurring-day').value = data.day_of_month || '';

                    if (data.start_date) {
                        document.getElementById('recurring-start-date').value = new Date(data.start_date).toISOString().split('T')[0];
                    }
                    if (data.end_date) {
                        document.getElementById('recurring-end-date').value = new Date(data.end_date).toISOString().split('T')[0];
                    }

                    recurringModal.show();
                }
            });
        });
    </script>
</body>

</html>
